# ghostty-translate-docs スキル開発コンテキスト

## 現在の状態

スキルは完成し、テスト済み。

### ファイル構成
```
.claude/skills/ghostty-translate-docs/
├── SKILL.md
├── CONTEXT.md              # このファイル
├── instructions/
│   ├── orchestrator.md     # オーケストレーター用指示書
│   └── translator.md       # 翻訳ワーカー用指示書
└── scripts/
    ├── prepare-translation.sh  # 前処理（バッチファイル作成まで）
    ├── split-docs.sh           # ghosttyからドキュメント分割のみ
    ├── detect-changes.sh       # 差分検出＆deprecated処理
    ├── split-docs-config.sh    # config分割
    └── split-docs-actions.sh   # actions分割

.claude/commands/ghostty-translate-docs.md  # スラッシュコマンド
```

### スクリプト責務

| スクリプト | 責務 |
|------------|------|
| prepare-translation.sh | 全体オーケストレーション、バッチファイル作成 |
| split-docs.sh | ghosttyからドキュメント取得・分割 |
| detect-changes.sh | ハッシュ比較・差分検出・deprecated処理 |

### 動作確認済み

- `prepare-translation.sh docs` → 正常動作
- 全て翻訳済みの場合 → `BATCH_COUNT=0` で終了
- 一部jaが欠けている → 欠けているファイルのみ翻訳対象
- enが変更された → 変更されたファイルのみ翻訳対象
- deprecated（ghosttyから削除された項目） → `DEPRECATED-*` にリネーム

### deprecated 対応

ghosttyから削除された設定/アクションは自動的に処理：
- `en/category/name.en.txt` → `en/category/DEPRECATED-name.en.txt`
- `ja/category/name.ja.txt` → `ja/category/DEPRECATED-name.ja.txt`
- stderr に `DEPRECATED: category/name` を出力

## アーキテクチャ設計

### スラッシュコマンドとスキルの役割分担

```
┌─────────────────────────────────────────────────────────────┐
│ スラッシュコマンド (.claude/commands/)                        │
│ - ユーザー向けのランチャー                                    │
│ - スキルを呼び出す指示を出すだけ                              │
│ - Claude固有の設定（Taskツール、model指定など）を記述         │
│ - Claude Code 依存 OK                                        │
└─────────────────────────────────────────────────────────────┘
                              ↓ 呼び出し
┌─────────────────────────────────────────────────────────────┐
│ スキル (.claude/skills/)                                     │
│ - 汎用的な処理定義                                           │
│ - オープンスタンダード準拠                                    │
│ - Claude固有の記述を排除（ポータブル）                        │
│ - 他のAIエージェントでも利用可能                              │
└─────────────────────────────────────────────────────────────┘
```

### 三段エージェント構成

翻訳のような大量コンテキストを消費するタスクでは、コンテキストを節約するために
三段構成を採用する：

```
┌──────────────────┐
│ メインエージェント │  コンテキスト: 最小
│ (ユーザーと対話)  │  役割: スラッシュコマンド実行のみ
└────────┬─────────┘
         │ Task (orchestrator起動)
         ↓
┌──────────────────┐
│ オーケストレーター │  コンテキスト: 中
│                  │  役割: 準備スクリプト実行、ワーカー起動管理
└────────┬─────────┘
         │ Task × N (並列)
         ↓
┌──────────────────┐
│ ワーカー × N     │  コンテキスト: 大（翻訳内容）
│                  │  役割: 実際の翻訳作業
└──────────────────┘
```

**なぜ三段構成か：**
1. メインのコンテキストを汚さない（オーケストレーター起動指示だけ）
2. 分割作業の指示自体にもコンテキストを消費する問題を回避
3. 各ワーカーは独立してコンテキストを持つので並列実行可能

### 【重要】サブエージェントのネスト制限

**Claude Code の制限**: サブエージェントは更にサブエージェントを起動できない。

```
メイン → オーケストレーター（OK）
オーケストレーター → ワーカー（NG！）← 不可能
```

**現状の対応策：**
- 少数ファイル: オーケストレーターが直接翻訳（問題なし）
- 大量ファイル: 未解決（以下の案を検討中）

**将来の解決案：**
1. **二段構成**: メイン（スラッシュコマンド）が直接ワーカーを並列起動
2. **ワーカー起動依頼**: オーケストレーターがメインに「これらのワーカーを起動してください」と返答し、メインが起動する

### 出力制御によるコンテキスト節約

**重要**: 各エージェントは処理結果の「内容」を返さない。

```
ワーカー:
  ✗ 翻訳結果を返す → オーケストレーターのコンテキストが爆発
  ○ ファイルに書き込み、「完了: 10件」とだけ返す

オーケストレーター:
  ✗ 全ワーカーの詳細結果を返す → メインのコンテキストが爆発
  ○ 結果リストはファイルに書き出し、パスと件数だけ返す
  ○ 「成功: 50件、失敗: 0件、結果: path/to/result.txt」
```

各層の責務：
- **ワーカー**: 翻訳してファイル保存、成功/失敗件数のみ報告
- **オーケストレーター**: ワーカー起動管理、結果リストをファイル化、パスと件数を報告
- **メイン**: ユーザーへ報告。リストが小さければ要約、大きければカテゴリ傾向を説明、詳細は必要に応じてファイル参照

### 適応的な報告（コンテキスト残量に応じた動作）

オーケストレーターは自身のコンテキスト残量を見て柔軟に対応：

```
コンテキストに余裕あり:
  → 結果リストを読んで要約作成
  → メインに要約付きで返す（メインのコンテキスト節約）

コンテキストが逼迫:
  → ファイルパスと件数のみ返す
  → 要約作業はメインに委ねる
```

これにより、状況に応じて最適なコンテキスト配分が可能になる。

### ワーカー起動の判断基準

オーケストレーターは状況に応じてワーカー起動を判断してよい：

```
少数ファイル（数件程度）:
  → オーケストレーターが直接翻訳してもOK
  → ワーカー起動のオーバーヘッドを避けられる
  → コンテキストも問題にならない

大量ファイル（数十件以上）:
  → ワーカーを起動して分割処理
  → コンテキスト爆発を防ぐ
```

**重要**: ワーカーも結局は同じ AI（コンテキストが異なるだけ）なので、
少数なら直接実行で問題ない。三段構成の目的は「コンテキスト節約」であり、
それが達成できるなら柔軟に判断してよい。

（外部サービスをワーカーとして使う場合は話が別だが、現状はそうではない）

### コンテキスト圧縮の原則

- 定型処理はスクリプト化（AIが毎回考える必要をなくす）
- AIは「スクリプト実行」「結果判断」「ワーカー起動」のみ
- 知る必要がないものは見せない

### テスト可能性

- detect-changes.sh は単体でテスト可能
- `detect-changes.sh <new-en> <en> <ja>` で任意のディレクトリをテスト

### ポータビリティ

- スキル内にClaude固有の記述を含めない
- bash 3.x互換（declare -A 不使用）
